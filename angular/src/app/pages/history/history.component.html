<div class="container">
  <h1 class="title">HISTORIAL DE PRUEBAS</h1>
</div>
<nz-tabset nzCentered>
  <nz-tab nzTitle="Pruebas pendientes">
    <div class="container">
      <nz-input-group nzPrefixIcon="filter" style="width: 300px; margin-bottom: 16px;">
        <input nz-input (keyup)="applyFilter($event, dataSourcePending)" placeholder="Ex. Allergy" />
      </nz-input-group>
      <nz-table #pendingTable [nzData]="dataSourcePending.data" [nzFrontPagination]="false" [nzShowPagination]="false" nzBordered>
        <thead>
          <tr>
            <th nzColumnKey="createdAt">Fecha</th>
            <th nzColumnKey="symptoms">Síntomas</th>
            <th nzColumnKey="result">Resultado</th>
            <th nzColumnKey="department">Departamento</th>
            <th nzColumnKey="remove">Eliminar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of dataSourcePending.data" (click)="readTest(row.id)" [ngClass]="{'read': row.unRead}">
            <td><nz-tag nzColor="red">{{row.createdAt | date:'dd/MM/yyyy h:mm a'}}</nz-tag></td>
            <td>
              <div *ngFor="let symptom of parseSymptoms(row.symptoms)">
                • {{symptom}}
              </div>
            </td>
            <td>
              <div *ngFor="let diagnosis of row.result" (click)="openDiagnosisDialog(diagnosis.name)" class="clickableText">
                • {{ diagnosis.name }} - %{{ (diagnosis.probability * 100).toFixed(2)}}
              </div>
            </td>
            <td>{{ row.department }}</td>
            <td>
              <button nz-button nzType="default" nzShape="circle" nzDanger (click)="openRemovePendingDialog(row.id); $event.stopPropagation();">
                <i nz-icon nzType="delete"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </nz-table>
      <nz-empty *ngIf="!dataSourcePending.data.length" nzNotFoundContent="No hay pruebas pendientes."></nz-empty>
    </div>
  </nz-tab>
  <nz-tab nzTitle="Pruebas en curso">
    <div class="container">
      <nz-input-group nzPrefixIcon="filter" style="width: 300px; margin-bottom: 16px;">
        <input nz-input (keyup)="applyFilter($event, dataSourceInProgress)" placeholder="Ex. Allergy" />
      </nz-input-group>
      <nz-table #progressTable [nzData]="dataSourceInProgress.data" [nzFrontPagination]="false" [nzShowPagination]="false" nzBordered>
        <thead>
          <tr>
            <th nzColumnKey="createdAt">Fecha</th>
            <th nzColumnKey="symptoms">Síntomas</th>
            <th nzColumnKey="result">Resultado</th>
            <th nzColumnKey="doctor">Doctor</th>
            <th nzColumnKey="department">Departamento</th>
            <th nzColumnKey="chat">Chat</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of dataSourceInProgress.data" (click)="readTest(row.id)" [ngClass]="{'read': row.unRead}">
            <td><nz-tag nzColor="gold">{{row.createdAt | date:'dd/MM/yyyy h:mm a'}}</nz-tag></td>
            <td>
              <div *ngFor="let symptom of parseSymptoms(row.symptoms)">
                • {{symptom}}
              </div>
            </td>
            <td>
              <div *ngFor="let diagnosis of row.result" (click)="openDiagnosisDialog(diagnosis.name)" class="clickableText">
                • {{ diagnosis.name }} - %{{ (diagnosis.probability * 100).toFixed(2)}}
              </div>
            </td>
            <td>{{ row.doctorname }}</td>
            <td>{{ row.department }}</td>
            <td>
              <ng-container *ngIf="row.chatID">
                <nz-badge *ngIf="isChatUnread(row.chatID)" [nzCount]="'*'" nzStatus="processing"></nz-badge>
                <button nz-button nzType="default" nzShape="circle" (click)="openChatDialog(row.chatID, row.id); $event.stopPropagation();">
                  <i nz-icon nzType="message" nzTheme="twotone"></i>
                </button>
              </ng-container>
              <ng-container *ngIf="!row.chatID">-</ng-container>
            </td>
          </tr>
        </tbody>
      </nz-table>
      <nz-empty *ngIf="!dataSourceInProgress.data.length" nzNotFoundContent="No hay pruebas en curso."></nz-empty>
    </div>
  </nz-tab>
  <nz-tab nzTitle="Pruebas finalizadas">
    <div class="container">
      <nz-input-group nzPrefixIcon="filter" style="width: 300px; margin-bottom: 16px;">
        <input nz-input (keyup)="applyFilter($event, dataSourceFinalized)" placeholder="Ex. Allergy" />
      </nz-input-group>
      <nz-table #finalizedTable [nzData]="dataSourceFinalized.data" [nzFrontPagination]="false" [nzShowPagination]="false" nzBordered>
        <thead>
          <tr>
            <th nzColumnKey="createdAt">Fecha</th>
            <th nzColumnKey="symptoms">Síntomas</th>
            <th nzColumnKey="result">Resultado</th>
            <th nzColumnKey="doctor">Doctor</th>
            <th nzColumnKey="department">Departamento</th>
            <th nzColumnKey="finalDiagnosis">Diagnóstico final</th>
            <th nzColumnKey="chat">Chat</th>
            <th nzColumnKey="rate">Reseña</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of dataSourceFinalized.data" (click)="readTest(row.id)" [ngClass]="{'read': row.unRead}">
            <td><nz-tag nzColor="green">{{row.createdAt | date:'dd/MM/yyyy h:mm a'}}</nz-tag></td>
            <td>
              <div *ngFor="let symptom of parseSymptoms(row.symptoms)">
                • {{symptom}}
              </div>
            </td>
            <td>
              <div *ngFor="let diagnosis of row.result" (click)="openDiagnosisDialog(diagnosis.name)" class="clickableText">
                • {{ diagnosis.name }} - %{{ (diagnosis.probability * 100).toFixed(2)}}
              </div>
            </td>
            <td>{{ row.doctorname }}</td>
            <td>{{ row.department }}</td>
            <td>
              <nz-tag *ngIf="row.finalDiagnosis == 'Canceled'" nzColor="red">{{row.finalDiagnosis}}</nz-tag>
              <span *ngIf="row.finalDiagnosis != 'Canceled'" (click)="openDiagnosisDialog(row.finalDiagnosis)" class="clickableText">{{row.finalDiagnosis}}</span>
            </td>
            <td>
              <ng-container *ngIf="row.chatID">
                <nz-badge *ngIf="isChatUnread(row.chatID)" [nzCount]="'*'" nzStatus="processing"></nz-badge>
                <button nz-button nzType="default" nzShape="circle" (click)="openChatDialog(row.chatID, row.id); $event.stopPropagation();">
                  <i nz-icon nzType="message" nzTheme="twotone"></i>
                </button>
              </ng-container>
              <ng-container *ngIf="!row.chatID">-</ng-container>
            </td>
            <td>
              <button nz-button nzType="default" nzShape="circle" (click)="openRateDialog(row.rate, row.id, row.doctorname); $event.stopPropagation();">
                <i nz-icon nzType="star"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </nz-table>
      <nz-empty *ngIf="!dataSourceFinalized.data.length" nzNotFoundContent="No hay pruebas finalizadas."></nz-empty>
    </div>
  </nz-tab>
</nz-tabset>
